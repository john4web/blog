<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  CQS and CQRS Principles: Splitting the Read from the Write Â· gersti.at
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Johannes Gerstbauer">
<meta name="description" content="Article explaining the CQS and CQRS principles in detail">
<meta name="keywords" content="blog, developer, software, engineer">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CQS and CQRS Principles: Splitting the Read from the Write"/>
<meta name="twitter:description" content="Article explaining the CQS and CQRS principles in detail"/>

<meta property="og:title" content="CQS and CQRS Principles: Splitting the Read from the Write" />
<meta property="og:description" content="Article explaining the CQS and CQRS principles in detail" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://gersti.at/posts/cqrs/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-11-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-11-20T00:00:00+00:00" />




<link rel="canonical" href="https://gersti.at/posts/cqrs/">


<link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.e1bdf152d93b060b06ba5d496486ed9c201a8b95d335e035beb5faebe3b61cad.css" integrity="sha256-4b3xUtk7BgsGul1JZIbtnCAai5XTNeA1vrX66&#43;O2HK0=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      gersti.at
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/about/">About</a>
            </li>
          
        
        
          
          
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="/de/posts/cqrs/">ðŸ‡©ðŸ‡ª</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://gersti.at/posts/cqrs/">
              CQS and CQRS Principles: Splitting the Read from the Write
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime="2024-11-20T00:00:00Z">
                November 20, 2024
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              9-minute read
            </span>
          </div>
          
          
          
        </div>
      </header>

      <div class="post-content">
        
        <p>In this blog article, we delve into two essential software design principles: <strong>Command and Query Separation (CQS)</strong> and <strong>Command-Query Responsibility Segregation (CQRS)</strong>.</p>
<figure><img src="/images/cqrs/ATM.jpg"
         alt="An example of separating commands and queries: the left ATM allows you to deposit money (command), and the right one shows your current balance (query)." width="70%"/><figcaption>
            <p>An example of separating commands and queries: the left ATM allows you to deposit money (command), and the right one shows your current balance (query).</p>
        </figcaption>
</figure>

<h1 id="command-and-query-separation-principle-cqs">
  Command and Query Separation Principle (CQS)
  <a class="heading-link" href="#command-and-query-separation-principle-cqs">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>CQS was introduced by Bertrand Meyer in 1994. As the creator of the programming language <a href="https://www.eiffel.org/"  class="external-link" target="_blank" rel="noopener"><em>Eiffel</em></a>, he also pioneered the concept of <em>&ldquo;Design by Contract&rdquo; (DbC)</em>, which I explored in greater detail in a recent blog post â€“ See: <a href="https://gersti.at/posts/liskov-substitution-principle/#design-by-contract-preconditions-postconditions-invariants"  class="external-link" target="_blank" rel="noopener">Here</a>.</p>
<p><strong>CQS essentially advises separating query operations from command operations within your methods.</strong>
But what exactly do we mean by a query or a command?</p>
<h2 id="query">
  Query
  <a class="heading-link" href="#query">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>A query is any method that retrieves information without changing the state of the system. A query is asking a question and returns the answer. <br>
For instance, a method that fetches data from a database and returns it to the caller qualifies as a query. It merely reads the data without modifying the application&rsquo;s state.</p>
<h2 id="command">
  Command
  <a class="heading-link" href="#command">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>A command represents an operation that alters the application&rsquo;s state. Unlike queries, commands do not return values.<br>
For example, a method that inserts an object into a database performs a write operation, thereby changing the state of the system. Such a method completes its task without returning a result.</p>
<h1 id="cqs-violation">
  CQS violation
  <a class="heading-link" href="#cqs-violation">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>The principleâ€™s goal is to ensure a clear separation between methods that change the applicationâ€™s state and those that do not.</p>
<ul>
<li>
<p>If a method performs a write operation on the database (changing the state) while returning a value, it breaks the CQS principle.</p>
</li>
<li>
<p>Similarly, if a method fetches data from a database but simultaneously modifies the state of the system, it also violates CQS.</p>
</li>
</ul>
<p>Combining commands and queries in one method is strictly prohibited! This principle is often summarized by a well-known quote:</p>
<blockquote>
<p>Asking a question should not change the answer!<!-- raw HTML omitted -->
â€” <!-- raw HTML omitted -->Bertrand Meyer<!-- raw HTML omitted --></p>
</blockquote>
<p>If these rules are adhered to, the following correlation naturally arises:<br>
A query will return the same result each time it is executed, unless a command has been performed in the meantime.</p>
<h1 id="cqs-and-rest-endpoints">
  CQS and REST Endpoints
  <a class="heading-link" href="#cqs-and-rest-endpoints">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>This principle is equally relevant when designing REST endpoints. Ensure that each endpoint either executes a query operation or a command operation, but not both at once. In the context of CRUD functionality, CREATE, UPDATE, and DELETE are command operations, whereas READ is a query operation.</p>
<p>Letâ€™s explore the five HTTP methods in REST:</p>
<ul>
<li><strong>GET</strong> (Requests a resource from the server)</li>
<li><strong>POST</strong> (Creates a new resource on the server)</li>
<li><strong>PUT</strong> (Modifies the entire resource on the server)</li>
<li><strong>DELETE</strong> (Deletes a resource from the server)</li>
<li><strong>PATCH</strong> (Modifies only parts of the resource on the server)</li>
</ul>
<p>Only the GET method aligns with a query operation. Methods like POST, PUT, DELETE, and PATCH are command operations, as they modify the application&rsquo;s state.</p>
<p>To adhere to the CQS principle with REST endpoints, an endpoint must not both return data and modify the state. If this occurs, the functionality should be split into two separate endpoints.</p>
<h1 id="advantages-of-cqs">
  Advantages of CQS
  <a class="heading-link" href="#advantages-of-cqs">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<ol>
<li>
<p><strong>Makes it easier to reason about your code:</strong> You develop an intuitive sense of whether a function alters the state. This allows you to quickly identify methods that are safe to call when you want to avoid changing the applicationâ€™s state.</p>
</li>
<li>
<p><strong>Isolation of mutations</strong></p>
</li>
<li>
<p><strong>Simpler code:</strong> Methods are reduced in size, easier to understand, and more focused on their specific task.</p>
</li>
<li>
<p><strong>Separation of concerns:</strong> Breaking down complex code into simpler, isolated tasks.</p>
</li>
<li>
<p><strong>Easier testing:</strong> Functions that focus on a single task are simpler to test.</p>
</li>
<li>
<p><strong>Clear API design:</strong> Using a naming convention to define which methods are queries and which are commands is a useful practice. I believe it&rsquo;s essential to apply this principle when designing REST endpoints.</p>
</li>
<li>
<p><strong>Not adhering to CQS can be risky:</strong> Imagine a scenario where a GET endpoint is called to perform a read operation, but the application&rsquo;s state is modified in the process. The caller might not be aware of this change, and their intention was probably not to alter the state by making this call.</p>
</li>
</ol>
<h1 id="exceptions--when-is-it-acceptable-to-violate-the-principle">
  Exceptions â€“ When is it acceptable to violate the principle?
  <a class="heading-link" href="#exceptions--when-is-it-acceptable-to-violate-the-principle">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>There are certain edge cases where violating this principle might be justified.</p>
<p>Martin Fowler discusses an interesting example in his <a href="https://martinfowler.com/bliki/CommandQuerySeparation.html"  class="external-link" target="_blank" rel="noopener">Online-Blog</a>, where he explains that the <code>pop</code> operation on a <code>stack</code> violates the principle. This is because it both retrieves an item from the <code>stack</code> and modifies its content, mixing a query and a command. Martin Fowler says: <em>&ldquo;So I prefer to follow this principle when I can, but I&rsquo;m prepared to break it to get my pop.&rdquo;</em>.</p>
<p>Recently, I encountered a similar situation at work. I was tasked with creating a new endpoint to save an object to the database, so I implemented a typical POST endpoint. As is standard, the resource to be saved is sent in the request body, and the endpoint inserts it into the database. Naturally, the entity in the database has an auto-generated ID as its primary key. All seemed fine up to this point.</p>
<p>However, shortly afterward, a frontend developer from my team approached me. He explained that the frontend needed the ID of the newly created object, as it would later use it to request the object through the <em>GetOneObjectByID</em> endpoint. He suggested that the POST endpoint (which saves the new object to the database) could also return the ID of the new object in the response body â€” or even better, the entire object. This would allow the frontend to process it immediately. Upon researching online, I learned that this is actually quite a common practice.</p>
<p>I was not at all convinced by the suggestion to mix command and query operations in the POST endpoint, as it directly violates the CQS principle. One potential solution I considered was creating a separate endpoint that returns the last object saved by the user. Yet, even this solution has its flaws, as it would introduce unnecessary complexity by requiring the program to check the <code>create_date</code> of the object in the database. Moreover, this additional endpoint wouldnâ€™t guarantee the return of the exact object, as it always fetches the most recent one. What if the user saves more objects? What if concurrency becomes an issue? How does the application behave under high load? This could introduce even more problems than the frontend developer&rsquo;s initial suggestion.</p>
<p>Another question is how endpoints should generally handle exceptions and errors. If a command operation throws an exception, should the endpoint return an error message in the response? This would also violate the principle. However, the frontend needs to notify the user when something goes wrong and, crucially, explain <em>WHAT</em> exactly went wrong. Without an error message in the response, this would be impossible.</p>
<p>As you can see, there are situations where following the CQS principle can be questioned. Ultimately, each developer must make an informed decision on whether to apply or violate the principle in each case. Software design principles are guidelines, not rigid rules, meant to improve code. However, these principles can sometimes conflict with each other. The key is to think carefully and make a conscious decision. Discussions with like-minded developers can be a valuable part of this process.</p>
<h1 id="command-query-responsibility-segregation-cqrs">
  Command-Query-Responsibility-Segregation (CQRS)
  <a class="heading-link" href="#command-query-responsibility-segregation-cqrs">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>As previously explained, CQS applies to functions or methods, while CQRS, the &ldquo;big brother&rdquo; of CQS, operates at the architectural level of applications. It treats reading and writing as entirely separate subsystems. CQRS was first introduced by <em>Greg Young</em> in 2010.</p>
<p><em>Udi Dahan</em> analyzes two key CQRS patterns in his presentation <a href="https://www.youtube.com/watch?v=Lw04HRF8ies"  class="external-link" target="_blank" rel="noopener">CQRS pitfalls and patterns</a>: the <em>&ldquo;Standard CQRS Pattern&rdquo;</em> and the <em>&ldquo;Eventually Consistent CQRS Pattern&rdquo;</em>. As illustrated in the following image, an application that follows the <em>&ldquo;Standard CQRS Pattern&rdquo;</em> utilizes two distinct APIs: one for query operations and one for command operations. The query API handles reading data from the database, while the command API is responsible for writing data. It&rsquo;s important to note that both APIs access the same database.</p>
<figure><img src="/images/cqrs/CQRS1.jpg"
         alt="The Standard CQRS Pattern (Source: Udi Dahan)." width="70%"/><figcaption>
            <p>The Standard CQRS Pattern (<em>Source: Udi Dahan</em>).</p>
        </figcaption>
</figure>

<p>You could take this approach even further by assigning a separate database to each API. Why would you do that? Because this allows you to tailor the query data model for fast read operations, while optimizing the command data model for write operations. Both sides can then perform their tasks more efficiently, as each is focused on a single purpose. However, this requires a mechanism to keep both databases in sync. When the command database is updated, the query database must reflect those changes as well. The following image illustrates the <em>&ldquo;Eventually Consistent CQRS Pattern&rdquo;</em>.</p>
<figure><img src="/images/cqrs/CQRS2.jpg"
         alt="The Eventually Consistent CQRS Pattern (Source: Udi Dahan)." width="70%"/><figcaption>
            <p>The Eventually Consistent CQRS Pattern (<em>Source: Udi Dahan</em>).</p>
        </figcaption>
</figure>

<p>In this architecture, the Query-API interacts with the Query-DB, and the Command-API interacts with the Command-DB. When the Command-API modifies data, an event is sent to a &ldquo;Query Updater,&rdquo; which propagates the changes to the Query-DB.
While this synchronization is typically asynchronous, it can introduce challenges such as delays. For example, users might experience inconsistencies when querying data theyâ€™ve just updated. These issues are especially problematic under high loads (e.g., 10,000 commands per second) or when the Query Updater becomes a bottleneck. Therefore, in CRUD systems, the <em>&ldquo;Eventually Consistent CQRS Pattern&rdquo;</em> should be avoided if the Query Updater cannot maintain pace.</p>
<p>It is crucial to emphasize that CQRS is an architectural style, not a universal &ldquo;best practice.&rdquo; Like any tool, it should be employed only when it is appropriate to the specific problem at hand. The decision to use CQRS ultimately rests with the software architect, who must carefully evaluate its relevance and benefits.</p>
<h1 id="reference">
  Reference
  <a class="heading-link" href="#reference">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<h2 id="videos">
  Videos
  <a class="heading-link" href="#videos">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<ul>
<li>
<p>Video from Christopher Okhravi: <em>Command Query Separation (CQS) | Code Walks 025</em>, URL: <a href="https://www.youtube.com/watch?v=zXJORh8K4Bw"  class="external-link" target="_blank" rel="noopener">https://www.youtube.com/watch?v=zXJORh8K4Bw</a>, Last Access: 21st November 2024.</p>
</li>
<li>
<p>Video from Bran van der Meer: <em>How to CQS: splitting the Read from the Write</em>, URL: <a href="https://www.youtube.com/watch?v=8-1fclzVm8w"  class="external-link" target="_blank" rel="noopener">https://www.youtube.com/watch?v=8-1fclzVm8w</a>, Last Access: 21st November 2024.</p>
</li>
</ul>
<h2 id="conference">
  Conference
  <a class="heading-link" href="#conference">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<ul>
<li>Presentation from Udi Dahan: <em>CQRS pitfalls and patterns</em>, NDC Conference in Oslo 22-26 May 2023, URL: <a href="https://www.youtube.com/watch?v=Lw04HRF8ies"  class="external-link" target="_blank" rel="noopener">https://www.youtube.com/watch?v=Lw04HRF8ies</a>, Last Access: 21st November 2024.</li>
</ul>
<h2 id="websites">
  Websites
  <a class="heading-link" href="#websites">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<ul>
<li>
<p>Blog-Article from Martin Fowler: <em>Command Query Separation</em>, URL: <a href="https://martinfowler.com/bliki/CommandQuerySeparation.html"  class="external-link" target="_blank" rel="noopener">https://martinfowler.com/bliki/CommandQuerySeparation.html</a>, Last Access: 21st November 2024.</p>
</li>
<li>
<p>Wikipedia-Article: <em>Commandâ€“query separation</em>, URL: <a href="https://en.wikipedia.org/wiki/Command%E2%80%93query_separation"  class="external-link" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Command%E2%80%93query_separation</a>, Last Access: 21st November 2024.</p>
</li>
<li>
<p>Wikipedia-Article: <em>Command-Query-Responsibility-Segregation</em>, URL: <a href="https://de.wikipedia.org/wiki/Command-Query-Responsibility-Segregation"  class="external-link" target="_blank" rel="noopener">https://de.wikipedia.org/wiki/Command-Query-Responsibility-Segregation</a>, Last Access: 21st November 2024.</p>
</li>
</ul>

      </div>


      <footer>
        


        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    Â©
    
      2024 -
    
    2025
     Johannes Gerstbauer 
    Â·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
